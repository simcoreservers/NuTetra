{% extends "base.html" %}

{% block title %}System Settings - NuTetra Hydroponic System{% endblock %}

{% block content %}
<div class="settings-container">
    <h2>System Settings</h2>
    
    <div class="settings-tabs">
        <button class="tab-button active" data-target="general-tab">General</button>
        <button class="tab-button" data-target="network-tab">Network</button>
        <button class="tab-button" data-target="hardware-tab">Hardware</button>
        <button class="tab-button" data-target="notification-tab">Notifications</button>
        <button class="tab-button" data-target="backup-tab">Backup/Restore</button>
    </div>
    
    <div class="tab-content active" id="general-tab">
        <div class="card">
            <h3>System Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">System Name:</span>
                    <span class="info-value" id="system-name">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Software Version:</span>
                    <span class="info-value" id="software-version">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">System Uptime:</span>
                    <span class="info-value" id="system-uptime">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Hardware Platform:</span>
                    <span class="info-value" id="hardware-platform">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">CPU Temperature:</span>
                    <span class="info-value" id="cpu-temp">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>System Name</h3>
            <div class="form-group">
                <label for="new-system-name">System Name:</label>
                <input type="text" id="new-system-name" placeholder="Enter system name">
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="save-system-name">Save</button>
            </div>
        </div>
        
        <div class="card">
            <h3>Date and Time</h3>
            <div class="form-group">
                <label for="date-time-auto">Automatic Date/Time:</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="date-time-auto">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="manual-date-time">
                <label for="system-date">Date:</label>
                <input type="date" id="system-date">
                <label for="system-time">Time:</label>
                <input type="time" id="system-time">
            </div>
            <div class="form-group">
                <label for="timezone">Timezone:</label>
                <select id="timezone">
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="Europe/London">London</option>
                    <option value="Europe/Berlin">Berlin</option>
                    <option value="Asia/Tokyo">Tokyo</option>
                    <option value="Australia/Sydney">Sydney</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="save-datetime">Save</button>
            </div>
        </div>
        
        <div class="card">
            <h3>System Maintenance</h3>
            <div class="maintenance-actions">
                <div class="maintenance-item">
                    <button class="btn primary-btn" id="system-update">Check for Updates</button>
                    <span class="maintenance-desc">Check for and install system updates</span>
                </div>
                <div class="maintenance-item">
                    <button class="btn secondary-btn" id="system-restart">Restart System</button>
                    <span class="maintenance-desc">Restart all nutetra services</span>
                </div>
                <div class="maintenance-item">
                    <button class="btn danger-btn" id="system-reboot">Reboot Device</button>
                    <span class="maintenance-desc">Reboot the Raspberry Pi</span>
                </div>
                <div class="maintenance-item">
                    <button class="btn danger-btn" id="clear-logs">Clear System Logs</button>
                    <span class="maintenance-desc">Clear all system logs and events</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="network-tab">
        <div class="card">
            <h3>Network Settings</h3>
            <div class="form-group">
                <label for="network-mode">Connection Type:</label>
                <select id="network-mode">
                    <option value="ethernet">Ethernet</option>
                    <option value="wifi">Wi-Fi</option>
                </select>
            </div>
            
            <div id="wifi-settings">
                <div class="form-group">
                    <label for="wifi-ssid">Wi-Fi SSID:</label>
                    <input type="text" id="wifi-ssid" placeholder="Enter Wi-Fi network name">
                </div>
                <div class="form-group">
                    <label for="wifi-password">Wi-Fi Password:</label>
                    <input type="password" id="wifi-password" placeholder="Enter Wi-Fi password">
                </div>
                <div class="button-group">
                    <button class="btn secondary-btn" id="scan-wifi">Scan Networks</button>
                </div>
                <div class="wifi-list" id="wifi-networks-list">
                    <!-- WiFi networks will be listed here -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="ip-auto">Automatic IP (DHCP):</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="ip-auto" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            
            <div id="static-ip-settings">
                <div class="form-group">
                    <label for="static-ip">IP Address:</label>
                    <input type="text" id="static-ip" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="subnet-mask">Subnet Mask:</label>
                    <input type="text" id="subnet-mask" placeholder="255.255.255.0">
                </div>
                <div class="form-group">
                    <label for="gateway">Gateway:</label>
                    <input type="text" id="gateway" placeholder="192.168.1.1">
                </div>
                <div class="form-group">
                    <label for="dns-server">DNS Server:</label>
                    <input type="text" id="dns-server" placeholder="8.8.8.8">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn primary-btn" id="save-network">Save Network Settings</button>
            </div>
        </div>
        
        <div class="card">
            <h3>Web Interface</h3>
            <div class="form-group">
                <label for="web-port">Web Server Port:</label>
                <input type="number" id="web-port" placeholder="8080" min="1" max="65535">
            </div>
            <div class="form-group">
                <label for="enable-ssl">Enable SSL:</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="enable-ssl">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="enable-auth">Enable Authentication:</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="enable-auth">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div id="auth-settings">
                <div class="form-group">
                    <label for="admin-username">Username:</label>
                    <input type="text" id="admin-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label for="admin-password">Password:</label>
                    <input type="password" id="admin-password" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password:</label>
                    <input type="password" id="confirm-password" placeholder="Confirm password">
                </div>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="save-web-settings">Save Web Settings</button>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="hardware-tab">
        <div class="card">
            <h3>Hardware Configuration</h3>
            <div class="hardware-info">
                <div class="info-item">
                    <span class="info-label">Detected Platform:</span>
                    <span class="info-value" id="detected-platform">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">GPIO Interface:</span>
                    <span class="info-value" id="gpio-interface">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">GPIO Chip:</span>
                    <span class="info-value" id="gpio-chip">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>Raspberry Pi 5 GPIO Settings</h3>
            <p>These settings are for advanced users. Incorrect configuration may cause hardware malfunctions.</p>
            <div class="form-group">
                <label for="gpio-chip-select">GPIO Chip:</label>
                <select id="gpio-chip-select">
                    <option value="4">gpiochip4 (Raspberry Pi 5)</option>
                    <option value="0">gpiochip0 (Older Raspberry Pi)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gpio-library">GPIO Library:</label>
                <select id="gpio-library">
                    <option value="rpi_lgpio">rpi-lgpio (Raspberry Pi 5)</option>
                    <option value="lgpio">lgpio (Standard)</option>
                    <option value="simulation">Simulation Mode</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="save-gpio-settings">Save GPIO Settings</button>
                <button class="btn secondary-btn" id="test-gpio">Test GPIO</button>
            </div>
        </div>
        
        <div class="card">
            <h3>Pin Assignments</h3>
            <div class="pin-assignments">
                <div class="form-section">
                    <h4>I2C Configuration</h4>
                    <div class="form-group">
                        <label for="i2c-enabled">Enable I2C:</label>
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="i2c-enabled" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="i2c-bus">I2C Bus:</label>
                        <select id="i2c-bus">
                            <option value="1">Bus 1 (Default)</option>
                            <option value="0">Bus 0</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Pump Control Pins</h4>
                    <div class="form-group">
                        <label for="ph-up-pin">pH Up Pump:</label>
                        <input type="number" id="ph-up-pin" min="0" max="27" value="17">
                    </div>
                    <div class="form-group">
                        <label for="ph-down-pin">pH Down Pump:</label>
                        <input type="number" id="ph-down-pin" min="0" max="27" value="27">
                    </div>
                    <div class="form-group">
                        <label for="nutrient-a-pin">Nutrient A Pump:</label>
                        <input type="number" id="nutrient-a-pin" min="0" max="27" value="22">
                    </div>
                    <div class="form-group">
                        <label for="nutrient-b-pin">Nutrient B Pump:</label>
                        <input type="number" id="nutrient-b-pin" min="0" max="27" value="23">
                    </div>
                    <div class="form-group">
                        <label for="main-pump-pin">Main Pump:</label>
                        <input type="number" id="main-pump-pin" min="0" max="27" value="24">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn primary-btn" id="save-pin-assignments">Save Pin Assignments</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="notification-tab">
        <div class="card">
            <h3>Email Notifications</h3>
            <div class="form-group">
                <label for="enable-email">Enable Email Alerts:</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="enable-email">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div id="email-settings">
                <div class="form-group">
                    <label for="smtp-server">SMTP Server:</label>
                    <input type="text" id="smtp-server" placeholder="smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label for="smtp-port">SMTP Port:</label>
                    <input type="number" id="smtp-port" placeholder="587">
                </div>
                <div class="form-group">
                    <label for="smtp-username">Email:</label>
                    <input type="email" id="smtp-username" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label for="smtp-password">Password:</label>
                    <input type="password" id="smtp-password" placeholder="Enter password or app password">
                </div>
                <div class="form-group">
                    <label for="notification-email">Notification Recipients:</label>
                    <input type="email" id="notification-email" placeholder="recipient@example.com">
                    <span class="help-text">Separate multiple emails with commas</span>
                </div>
                <div class="button-group">
                    <button class="btn secondary-btn" id="test-email">Send Test Email</button>
                    <button class="btn primary-btn" id="save-email-settings">Save Email Settings</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>Push Notifications</h3>
            <div class="form-group">
                <label for="enable-push">Enable Push Notifications:</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="enable-push">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div id="push-settings">
                <div class="form-group">
                    <label>Push Service:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="push-service" value="pushover" checked>
                            Pushover
                        </label>
                        <label>
                            <input type="radio" name="push-service" value="telegram">
                            Telegram
                        </label>
                    </div>
                </div>
                
                <div id="pushover-settings">
                    <div class="form-group">
                        <label for="pushover-user-key">User Key:</label>
                        <input type="text" id="pushover-user-key" placeholder="Enter Pushover user key">
                    </div>
                    <div class="form-group">
                        <label for="pushover-app-token">App Token:</label>
                        <input type="text" id="pushover-app-token" placeholder="Enter Pushover app token">
                    </div>
                </div>
                
                <div id="telegram-settings" style="display: none;">
                    <div class="form-group">
                        <label for="telegram-bot-token">Bot Token:</label>
                        <input type="text" id="telegram-bot-token" placeholder="Enter Telegram bot token">
                    </div>
                    <div class="form-group">
                        <label for="telegram-chat-id">Chat ID:</label>
                        <input type="text" id="telegram-chat-id" placeholder="Enter Telegram chat ID">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn secondary-btn" id="test-push">Send Test Notification</button>
                    <button class="btn primary-btn" id="save-push-settings">Save Push Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="backup-tab">
        <div class="card">
            <h3>System Backup</h3>
            <p>Back up your system configuration, sensor history, and custom settings.</p>
            <div class="form-group">
                <label for="backup-settings">Include Settings:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="backup-settings" checked>
                </div>
            </div>
            <div class="form-group">
                <label for="backup-history">Include Sensor History:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="backup-history" checked>
                </div>
            </div>
            <div class="form-group">
                <label for="backup-logs">Include Logs:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="backup-logs">
                </div>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="create-backup">Create Backup</button>
            </div>
            
            <div class="backup-list">
                <h4>Available Backups</h4>
                <div id="backup-files"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>System Restore</h3>
            <p>Restore system from a previous backup or upload a backup file.</p>
            <div class="form-group">
                <label for="backup-file">Upload Backup File:</label>
                <input type="file" id="backup-file" accept=".zip">
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="restore-backup">Restore from Backup</button>
            </div>
        </div>
        
        <div class="card">
            <h3>Factory Reset</h3>
            <p class="warning-text">⚠️ This will reset the system to factory defaults and erase all data.</p>
            <div class="form-group">
                <label for="confirm-reset">Type "RESET" to confirm:</label>
                <input type="text" id="confirm-reset" placeholder="RESET">
            </div>
            <div class="button-group">
                <button class="btn danger-btn" id="factory-reset">Factory Reset</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">Confirm Action</h3>
        <p id="modal-message">Are you sure you want to perform this action?</p>
        <div class="button-group">
            <button class="btn danger-btn" id="modal-confirm">Confirm</button>
            <button class="btn secondary-btn" id="modal-cancel">Cancel</button>
        </div>
    </div>
</div>

<div id="status-message" class="status-message"></div>
{% endblock %}

{% block scripts %}
<script>
    // Function to show/hide elements based on checkbox state
    function toggleVisibility(controlId, targetId) {
        const control = document.getElementById(controlId);
        const target = document.getElementById(targetId);
        
        if (control && target) {
            control.addEventListener('change', function() {
                target.style.display = this.checked ? 'none' : 'block';
            });
            
            // Set initial state
            target.style.display = control.checked ? 'none' : 'block';
        }
    }
    
    // Function to show/hide elements based on radio selection
    function setupRadioToggle(radioName, options) {
        const radios = document.getElementsByName(radioName);
        
        radios.forEach(radio => {
            radio.addEventListener('change', function() {
                for (const option in options) {
                    const element = document.getElementById(options[option]);
                    if (element) {
                        element.style.display = this.value === option ? 'block' : 'none';
                    }
                }
            });
        });
        
        // Set initial state
        for (const radio of radios) {
            if (radio.checked) {
                for (const option in options) {
                    const element = document.getElementById(options[option]);
                    if (element) {
                        element.style.display = radio.value === option ? 'block' : 'none';
                    }
                }
                break;
            }
        }
    }
    
    // Set up tab navigation - wrap in DOMContentLoaded to ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, setting up tabs");
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        console.log("Found tab buttons:", tabButtons.length);
        console.log("Found tab contents:", tabContents.length);
        
        // List all tab buttons and their targets for debugging
        tabButtons.forEach(btn => {
            console.log("Tab button:", btn.textContent.trim(), "Target:", btn.getAttribute('data-target'));
        });
        
        // List all tab contents and their IDs for debugging
        tabContents.forEach(content => {
            console.log("Tab content ID:", content.id);
        });
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                console.log("Tab clicked:", this.textContent.trim(), "Target:", target);
                
                // Set active button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show target content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === target) {
                        console.log("Activating content:", content.id);
                        content.classList.add('active');
                    }
                });
            });
        });
        
        console.log("Tab setup complete");
    });
    
    // Set up toggle visibility (move inside DOMContentLoaded)
    document.addEventListener('DOMContentLoaded', function() {
        toggleVisibility('date-time-auto', 'manual-date-time');
        toggleVisibility('ip-auto', 'static-ip-settings');
        toggleVisibility('enable-auth', 'auth-settings', true);
        toggleVisibility('enable-email', 'email-settings', true);
        toggleVisibility('enable-push', 'push-settings', true);
        
        // Set up radio toggle
        setupRadioToggle('push-service', {
            'pushover': 'pushover-settings',
            'telegram': 'telegram-settings'
        });
    });
    
    // Function to show status message
    function showStatusMessage(message, type = 'success') {
        const statusMessage = document.getElementById('status-message');
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
        }, 3000);
    }
    
    // Confirmation modal setup
    function setupConfirmation(buttonId, title, message, onConfirm) {
        const button = document.getElementById(buttonId);
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const confirmButton = document.getElementById('modal-confirm');
        const cancelButton = document.getElementById('modal-cancel');
        
        if (button) {
            button.addEventListener('click', function() {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.style.display = 'block';
                
                // Set up temporary confirm handler
                const confirmHandler = function() {
                    onConfirm();
                    modal.style.display = 'none';
                    confirmButton.removeEventListener('click', confirmHandler);
                };
                
                confirmButton.addEventListener('click', confirmHandler);
                
                cancelButton.addEventListener('click', function() {
                    modal.style.display = 'none';
                    confirmButton.removeEventListener('click', confirmHandler);
                });
            });
        }
    }
    
    // Set up confirmation handlers (move inside DOMContentLoaded)
    document.addEventListener('DOMContentLoaded', function() {
        setupConfirmation('system-restart', 'Restart System', 
            'Are you sure you want to restart all nutetra services?', 
            function() {
                // Send restart services request
                fetch('/api/system/restart', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatusMessage('System services restarting...', 'success');
                        } else {
                            showStatusMessage(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showStatusMessage(`Error: ${error.message}`, 'error');
                    });
            }
        );
        
        setupConfirmation('system-reboot', 'Reboot Device', 
            'Are you sure you want to reboot the Raspberry Pi? This will disconnect your session.',
            function() {
                // Send reboot request
                fetch('/api/system/reboot', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatusMessage('Device is rebooting. Please wait...', 'success');
                            
                            // Show countdown to reconnect
                            setTimeout(() => {
                                document.body.innerHTML = '<div class="reboot-message">' +
                                    '<h2>Device is rebooting</h2>' +
                                    '<p>Please wait while the system restarts.</p>' +
                                    '<p>This page will attempt to reconnect in <span id="countdown">60</span> seconds.</p>' +
                                    '</div>';
                                
                                let countdown = 60;
                                const countdownElement = document.getElementById('countdown');
                                
                                const interval = setInterval(() => {
                                    countdown--;
                                    countdownElement.textContent = countdown;
                                    
                                    if (countdown <= 0) {
                                        clearInterval(interval);
                                        window.location.reload();
                                    }
                                }, 1000);
                            }, 2000);
                        } else {
                            showStatusMessage(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showStatusMessage(`Error: ${error.message}`, 'error');
                    });
            }
        );
        
        setupConfirmation('clear-logs', 'Clear System Logs', 
            'Are you sure you want to clear all system logs? This cannot be undone.',
            function() {
                // Send clear logs request
                fetch('/api/system/clear-logs', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatusMessage('System logs cleared', 'success');
                        } else {
                            showStatusMessage(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showStatusMessage(`Error: ${error.message}`, 'error');
                    });
            }
        );
        
        setupConfirmation('factory-reset', 'Factory Reset', 
            'WARNING: This will reset all settings and erase all data. This cannot be undone!',
            function() {
                const confirmInput = document.getElementById('confirm-reset');
                
                if (confirmInput.value === 'RESET') {
                    // Send factory reset request
                    fetch('/api/system/factory-reset', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showStatusMessage('Factory reset initiated. System will reboot.', 'success');
                                
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 5000);
                            } else {
                                showStatusMessage(`Error: ${data.message}`, 'error');
                            }
                        })
                        .catch(error => {
                            showStatusMessage(`Error: ${error.message}`, 'error');
                        });
                } else {
                    showStatusMessage('Please type "RESET" to confirm factory reset', 'error');
                }
            }
        );
    });
    
    // Load system information
    function loadSystemInfo() {
        fetch('/api/system/info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('system-name').textContent = data.system_name;
                document.getElementById('software-version').textContent = data.version;
                document.getElementById('system-uptime').textContent = data.uptime;
                document.getElementById('hardware-platform').textContent = data.platform;
                document.getElementById('cpu-temp').textContent = data.cpu_temp;
                document.getElementById('detected-platform').textContent = data.platform;
                document.getElementById('gpio-interface').textContent = data.gpio_interface;
                document.getElementById('gpio-chip').textContent = data.gpio_chip ? `gpiochip${data.gpio_chip}` : 'Not detected';
                
                // Also set form values
                document.getElementById('new-system-name').value = data.system_name;
                
                if (data.gpio_chip !== null) {
                    document.getElementById('gpio-chip-select').value = data.gpio_chip;
                }
                
                if (data.gpio_interface) {
                    if (data.gpio_interface.includes('rpi_lgpio')) {
                        document.getElementById('gpio-library').value = 'rpi_lgpio';
                    } else if (data.gpio_interface.includes('lgpio')) {
                        document.getElementById('gpio-library').value = 'lgpio';
                    } else if (data.gpio_interface.includes('simulation')) {
                        document.getElementById('gpio-library').value = 'simulation';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading system info:', error);
            });
    }
    
    // Save system name
    document.addEventListener('DOMContentLoaded', function() {
        const saveSystemNameBtn = document.getElementById('save-system-name');
        if (saveSystemNameBtn) {
            saveSystemNameBtn.addEventListener('click', function() {
                const newName = document.getElementById('new-system-name').value.trim();
                
                if (newName) {
                    fetch('/api/system/name', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: newName }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatusMessage('System name updated', 'success');
                            document.getElementById('system-name').textContent = newName;
                        } else {
                            showStatusMessage(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showStatusMessage(`Error: ${error.message}`, 'error');
                    });
                } else {
                    showStatusMessage('System name cannot be empty', 'error');
                }
            });
        } else {
            console.error("Save system name button not found");
        }
    });

    // Save GPIO settings
    document.addEventListener('DOMContentLoaded', function() {
        const saveGpioBtn = document.getElementById('save-gpio-settings');
        if (saveGpioBtn) {
            saveGpioBtn.addEventListener('click', function() {
                const chipNumber = document.getElementById('gpio-chip-select').value;
                const library = document.getElementById('gpio-library').value;
                
                fetch('/api/system/gpio-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        gpio_chip: parseInt(chipNumber),
                        gpio_library: library
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatusMessage('GPIO settings updated. Restart services to apply changes.', 'success');
                        
                        // Update displayed info
                        document.getElementById('gpio-chip').textContent = `gpiochip${chipNumber}`;
                        document.getElementById('gpio-interface').textContent = library;
                    } else {
                        showStatusMessage(`Error: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatusMessage(`Error: ${error.message}`, 'error');
                });
            });
        } else {
            console.error("Save GPIO settings button not found");
        }
    });
    
    // Test GPIO
    document.addEventListener('DOMContentLoaded', function() {
        const testGpioBtn = document.getElementById('test-gpio');
        if (testGpioBtn) {
            testGpioBtn.addEventListener('click', function() {
                fetch('/api/system/test-gpio', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatusMessage('GPIO test successful', 'success');
                        } else {
                            showStatusMessage(`GPIO test failed: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showStatusMessage(`Error: ${error.message}`, 'error');
                    });
            });
        } else {
            console.error("Test GPIO button not found");
        }
    });
    
    // Save pin assignments
    document.addEventListener('DOMContentLoaded', function() {
        const savePinsBtn = document.getElementById('save-pin-assignments');
        if (savePinsBtn) {
            savePinsBtn.addEventListener('click', function() {
                const pinAssignments = {
                    ph_up: parseInt(document.getElementById('ph-up-pin').value),
                    ph_down: parseInt(document.getElementById('ph-down-pin').value),
                    nutrient_a: parseInt(document.getElementById('nutrient-a-pin').value),
                    nutrient_b: parseInt(document.getElementById('nutrient-b-pin').value),
                    main: parseInt(document.getElementById('main-pump-pin').value),
                    i2c_bus: parseInt(document.getElementById('i2c-bus').value),
                    i2c_enabled: document.getElementById('i2c-enabled').checked
                };
                
                fetch('/api/system/pin-assignments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pinAssignments),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatusMessage('Pin assignments saved. Restart services to apply changes.', 'success');
                    } else {
                        showStatusMessage(`Error: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatusMessage(`Error: ${error.message}`, 'error');
                });
            });
        } else {
            console.error("Save pin assignments button not found");
        }
    });
    
    // Initialize system info on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Loading system info");
        loadSystemInfo();
    });
</script>
{% endblock %} 